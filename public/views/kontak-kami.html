<!doctype html>
<html lang="id">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Contact Us By Lokerkesehatanid</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@4/animate.min.css" />
  <link rel="stylesheet" href="../assets/kontakkami.css" />
</head>

<body>
  <div class="form-card">
    <h1>Contact Us by Loker Kesehatan ID</h1>
    <p>Ada pertanyaan? Jangan ragu untuk menghubungi kami</p>
    <form id="contactForm">
      <div class="mb-3">
        <label for="nama" class="form-label">Nama <span class="text-danger">*</span></label>
        <input type="text" id="nama" name="nama" class="form-control" required />
        <div class="invalid-feedback">Wajib diisi</div>
      </div>

      <div class="mb-3">
        <label for="no_wa" class="form-label">Nomor WhatsApp <span class="text-danger">*</span></label>
        <input type="text" id="no_wa" name="no_wa" class="form-control" required />
        <div class="invalid-feedback">
          Wajib diisi angka dan no WA yang valid ya
        </div>
      </div>

      <div class="mb-3">
        <label for="isi_pesan" class="form-label">Isi Pesan <span class="text-danger">*</span></label>
        <textarea id="isi_pesan" name="isi_pesan" class="form-control" rows="4" required></textarea>
        <div class="invalid-feedback">Wajib diisi</div>
      </div>

      <button type="submit" id="submitBtn" class="btn btn-primary w-100">
        Kirim Pesan
      </button>
      <footer>
        <a href="/index.html">Loker Kesehatan ID</a> Â© 2018 - <span id="year"></span>
      </footer>
    </form>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script>
    document.getElementById("year").textContent = new Date().getFullYear();

    const form = document.getElementById("contactForm");
    const namaField = document.getElementById("nama");
    const waField = document.getElementById("no_wa");
    const pesanField = document.getElementById("isi_pesan");

    function updateFieldFeedback(field) {
      let feedback = field.nextElementSibling;
      if (!feedback || !feedback.classList.contains("invalid-feedback")) {
        const parent =
          field.closest(".mb-3, .form-group") || field.parentElement;
        feedback = parent ? parent.querySelector(".invalid-feedback") : null;
      }
      if (!feedback) return;
      feedback.style.display = field.classList.contains("is-invalid")
        ? "block"
        : "none";
    }

    function validateField(field, condition) {
      if (!condition) {
        field.classList.remove("is-valid");
        field.classList.add("is-invalid");
      } else {
        field.classList.remove("is-invalid");
        field.classList.add("is-valid");
      }
      updateFieldFeedback(field);
    }

    function validateWA() {
      const wa = waField.value.replace(/\D/g, "");
      waField.value = wa;
      const isValid = /^\d{10,13}$/.test(wa);
      validateField(waField, isValid);
      return isValid;
    }

    function validateFormFields() {
      let valid = true;
      validateField(namaField, namaField.value.trim() !== "");
      const isValidWA = validateWA(); // hanya sekali
      validateField(waField, isValidWA);
      validateField(pesanField, pesanField.value.trim() !== "");

      form.querySelectorAll(".form-control").forEach((f) => {
        if (f.classList.contains("is-invalid")) valid = false;
      });

      return valid;
    }

    waField.addEventListener("input", validateWA);
    form.addEventListener("input", (e) => {
      const field = e.target;
      if (field.matches("#nama"))
        validateField(field, field.value.trim() !== "");
      if (field.matches("#isi_pesan"))
        validateField(field, field.value.trim() !== "");
    });

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      if (!validateFormFields()) {
        const firstInvalid = form.querySelector(".is-invalid");
        if (firstInvalid) firstInvalid.focus();
        return;
      }

      const submitBtn = document.getElementById("submitBtn");

      Swal.fire({
        title: "Menyimpan pesan...",
        text: "Mohon tunggu sebentar.",
        allowOutsideClick: false,
        allowEscapeKey: false,
        didOpen: () => Swal.showLoading(),
      });

      submitBtn.disabled = true;
      submitBtn.innerHTML = `
    <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
    Mengirim...
  `;

      const nama = namaField.value.trim();
      const wa = waField.value.trim();
      const isiPesan = pesanField.value.trim();
      const data = { nama, wa, isiPesan };

      const scriptURL =
        "https://script.google.com/macros/s/AKfycbztu0VlT9aVNgqxLLm8e687FypkgYFPYUsqlThUH2R8d8sZNGg9P2Vn72dfSuYkWnc/exec";
      const ADMIN_WA = "6287713314496";

      try {
        const res = await fetch(scriptURL, {
          method: "POST",
          body: JSON.stringify(data),
        });
        const result = await res.json();

        if (result.result === "success") {
          const pesan = `Hai admin @lokerkesehatanid, nama saya ${data.nama}\nwa : ${data.wa}\n\n${data.isiPesan}`;
          const pesanUrl = `https://wa.me/${ADMIN_WA}?text=${encodeURIComponent(pesan)}`;

          Swal.fire({
            icon: "success",
            title: "Pesan berhasil disimpan!",
            text: "Klik tombol OK untuk kirim ke admin via WhatsApp",
            confirmButtonText: "OK, kirim ke admin",
            confirmButtonColor: "#127720",
            allowOutsideClick: false,
            allowEscapeKey: false,
          }).then(() => {
            window.location.href = pesanUrl;
            form.reset();
            form.querySelectorAll(".form-control").forEach((field) => {
              field.classList.remove("is-valid", "is-invalid");
            });
          });
        } else {
          Swal.fire({
            icon: "error",
            title: "Gagal menyimpan pesan!",
            text: result.message || "Terjadi kesalahan di server.",
            confirmButtonText: "OK",
          });
        }
      } catch (err) {
        Swal.fire({
          icon: "error",
          title: "Terjadi kesalahan!",
          text: err.message,
          confirmButtonText: "OK",
        });
      } finally {
        submitBtn.disabled = false;
        submitBtn.innerHTML = `Kirim Pesan`;
      }
    });
  </script>
</body>

</html>